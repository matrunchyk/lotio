name: Test Built Artifacts

on:
  workflow_run:
    workflows: ["Build, Package and Release"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to test (e.g., v1.2.3)'
        type: string
        required: false

permissions:
  contents: read
  packages: read

concurrency:
  group: test
  cancel-in-progress: true

jobs:
  test-docker-image:
    name: Test Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Get latest tag
            VERSION=$(git describe --tags --match 'v*.*.*' --abbrev=0 2>/dev/null || echo "latest")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Testing version: $VERSION"

      - name: Pull Docker image
        run: |
          if [ "${{ steps.version.outputs.VERSION }}" != "latest" ]; then
            docker pull matrunchyk/lotio:${{ steps.version.outputs.VERSION }}
          else
            docker pull matrunchyk/lotio:latest
          fi

      - name: Test --help
        run: |
          docker run --rm matrunchyk/lotio:latest --help

      - name: Test --version
        run: |
          docker run --rm matrunchyk/lotio:latest --version

      - name: Test library functionality
        run: |
          # Create a minimal test
          echo '{"v":"5.5.2","fr":30,"w":100,"h":100,"ip":0,"op":30,"layers":[]}' > /tmp/test.json
          mkdir -p /tmp/output
          docker run --rm \
            -v /tmp/test.json:/workspace/test.json:ro \
            -v /tmp/output:/workspace/output \
            matrunchyk/lotio:latest \
            /workspace/test.json /workspace/output 30

      - name: Test video generation with --debug
        run: |
          echo '{"v":"5.5.2","fr":30,"w":100,"h":100,"ip":0,"op":30,"layers":[]}' > /tmp/test2.json
          mkdir -p /tmp/output2
          docker run --rm \
            -v /tmp/test2.json:/workspace/test2.json:ro \
            -v /tmp/output2:/workspace/output2 \
            matrunchyk/lotio:latest \
            --debug /workspace/test2.json /workspace/output2 30

  test-js-wasm:
    name: Test JS/WASM Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure npm for GitHub Packages
        run: |
          echo "@matrunchyk:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: Install lotio npm package
        run: |
          npm install @matrunchyk/lotio

      - name: Test library loads
        run: |
          node -e "
            import('@matrunchyk/lotio').then(module => {
              console.log('✅ Library loaded successfully');
              console.log('Exports:', Object.keys(module));
            }).catch(err => {
              console.error('❌ Failed to load library:', err);
              process.exit(1);
            });
          "

      - name: Test basic API
        run: |
          node -e "
            import('@matrunchyk/lotio').then(async (module) => {
              console.log('Testing API...');
              // Basic smoke test - just check if functions exist
              if (typeof module.initLotio === 'function') {
                console.log('✅ initLotio function exists');
              }
              if (typeof module.createAnimation === 'function') {
                console.log('✅ createAnimation function exists');
              }
              console.log('✅ Basic API test passed');
            }).catch(err => {
              console.error('❌ API test failed:', err);
              process.exit(1);
            });
          "

      - name: Install jsdom for Node.js DOM support
        run: |
          npm install --save-dev jsdom

      - name: Test frame rendering
        run: |
          node --input-type=module << 'EOF'
          import { JSDOM } from 'jsdom';
          import { readFileSync } from 'fs';
          import { fileURLToPath } from 'url';
          import { dirname, join } from 'path';
          
          // Set up jsdom for browser-like environment
          const dom = new JSDOM('<!DOCTYPE html><html><body></body></html>', {
            url: 'http://localhost',
            pretendToBeVisual: true,
            resources: 'usable'
          });
          
          global.window = dom.window;
          global.document = dom.window.document;
          global.navigator = dom.window.navigator;
          global.HTMLCanvasElement = dom.window.HTMLCanvasElement;
          global.ImageData = dom.window.ImageData;
          
          // Now import lotio (it will use the jsdom environment)
          const { initLotio, createAnimation, renderFrameRGBA } = await import('@matrunchyk/lotio/browser/wasm.js');
          
          const __filename = fileURLToPath(import.meta.url);
          const __dirname = dirname(__filename);
          
          // Simple Lottie animation JSON (100x100, 30fps, 1 second duration)
          const animationJson = {
            v: '5.5.2',
            fr: 30,
            ip: 0,
            op: 30,
            w: 100,
            h: 100,
            nm: 'Test Animation',
            ddd: 0,
            assets: [],
            layers: [
              {
                ddd: 0,
                ind: 1,
                ty: 4,
                nm: 'Shape Layer',
                sr: 1,
                ks: {
                  o: { a: 0, k: 100 },
                  r: { a: 0, k: 0 },
                  p: { a: 0, k: [50, 50, 0] },
                  a: { a: 0, k: [0, 0, 0] },
                  s: { a: 0, k: [100, 100, 100] }
                },
                ao: 0,
                shapes: [
                  {
                    ty: 'gr',
                    it: [
                      {
                        d: 1,
                        ty: 'el',
                        s: { a: 0, k: [40, 40] },
                        p: { a: 0, k: [0, 0] }
                      },
                      {
                        ty: 'fl',
                        c: { a: 0, k: [1, 0, 0, 1] }
                      }
                    ]
                  }
                ],
                ip: 0,
                op: 30,
                st: 0,
                bm: 0
              }
            ]
          };
          
          try {
            console.log('Initializing lotio...');
            // Find wasm file in node_modules
            const wasmPath = join(process.cwd(), 'node_modules', '@matrunchyk', 'lotio', 'browser', 'lotio.wasm');
            await initLotio(wasmPath);
            console.log('✅ WASM initialized');
            
            console.log('Creating animation...');
            const info = createAnimation(animationJson, null, 0.97, 'accurate');
            console.log('✅ Animation created:', info);
            
            if (!info || !info.width || !info.height) {
              throw new Error('Invalid animation info returned');
            }
            
            console.log('Rendering frame at time 0.5...');
            const frame = renderFrameRGBA(0.5);
            console.log('✅ Frame rendered');
            
            if (!frame || !frame.rgba || !frame.width || !frame.height) {
              throw new Error('Invalid frame data returned');
            }
            
            // Verify frame data
            if (frame.width !== 100 || frame.height !== 100) {
              throw new Error(\`Expected 100x100 frame, got \${frame.width}x\${frame.height}\`);
            }
            
            if (!(frame.rgba instanceof Uint8Array)) {
              throw new Error('Frame rgba is not a Uint8Array');
            }
            
            const expectedSize = frame.width * frame.height * 4; // RGBA = 4 bytes per pixel
            if (frame.rgba.length !== expectedSize) {
              throw new Error(\`Expected rgba array size \${expectedSize}, got \${frame.rgba.length}\`);
            }
            
            // Check that frame has non-zero data (not all black/transparent)
            const hasData = frame.rgba.some(val => val !== 0);
            if (!hasData) {
              console.warn('⚠️  Warning: Frame appears to be all zeros (may be valid for empty animation)');
            }
            
            console.log('✅ Frame rendering test passed');
            console.log(\`   Frame size: \${frame.width}x\${frame.height}\`);
            console.log(\`   RGBA data size: \${frame.rgba.length} bytes\`);
            console.log(\`   Has non-zero data: \${hasData}\`);
          } catch (error) {
            console.error('❌ Frame rendering test failed:', error);
            console.error(error.stack);
            process.exit(1);
          }
          EOF

  test-homebrew:
    name: Test Homebrew Package
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Tap Homebrew repository
        run: |
          brew tap matrunchyk/lotio

      - name: Install lotio via Homebrew
        run: |
          brew install lotio

      - name: Test --help
        run: |
          lotio --help

      - name: Test --version
        run: |
          lotio --version

      - name: Test basic functionality
        run: |
          echo '{"v":"5.5.2","fr":30,"w":100,"h":100,"ip":0,"op":30,"layers":[]}' > /tmp/test.json
          mkdir -p /tmp/output
          lotio /tmp/test.json /tmp/output 30

