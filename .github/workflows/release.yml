name: Build, Package and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          # Check if we're on a semantic version tag (v1.1.0, v2.0.0, etc.)
          if git describe --tags --exact-match HEAD 2>/dev/null | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
            # Use the semantic version tag
            VERSION=$(git describe --tags --exact-match HEAD)
            echo "Using semantic version tag: $VERSION"
          else
            # Fall back to date-SHA format
            DATE=$(date +%Y%m%d)
            SHA=$(git rev-parse --short HEAD)
            VERSION="v${DATE}-${SHA}"
            echo "Using date-SHA version: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          # Extract version number for Homebrew (remove 'v' prefix)
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install dependencies
        run: |
          brew install fontconfig freetype harfbuzz icu4c libpng jpeg-turbo webp ninja python@3.11

      - name: Cache Skia
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: third_party/skia/skia
          key: skia-${{ runner.os }}-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            skia-${{ runner.os }}-

      - name: Fetch Skia
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          mkdir -p third_party/skia
          cd third_party/skia
          # Remove existing directory if it exists (from partial cache or previous runs)
          rm -rf skia
          git config --global advice.detachedHead false
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          chmod +x "$GITHUB_WORKSPACE/sync_skia_deps.sh"
          "$GITHUB_WORKSPACE/sync_skia_deps.sh" .
          echo "Skia cloned and dependencies synced successfully"

      - name: Cache Skia Build
        id: cache-skia-build
        uses: actions/cache@v4
        with:
          path: third_party/skia/skia/out/Release
          key: skia-build-${{ runner.os }}-${{ hashFiles('install_skia.sh') }}
          restore-keys: |
            skia-build-${{ runner.os }}-

      - name: Build Skia
        if: steps.cache-skia-build.outputs.cache-hit != 'true'
        run: |
          chmod +x install_skia.sh
          ./install_skia.sh

      - name: Build lotio
        run: |
          chmod +x build_local.sh
          ./build_local.sh

      - name: Test binary
        run: |
          ./lotio --help

      - name: Create developer package
        id: dev_package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio-dev-${VERSION}"
          mkdir -p "$PKG_NAME"
          
          # Binary
          cp lotio "$PKG_NAME/"
          
          # Headers (for development)
          mkdir -p "$PKG_NAME/include/lotio"
          cp -r src/core/*.h "$PKG_NAME/include/lotio/core/" 2>/dev/null || true
          cp -r src/text/*.h "$PKG_NAME/include/lotio/text/" 2>/dev/null || true
          cp -r src/utils/*.h "$PKG_NAME/include/lotio/utils/" 2>/dev/null || true
          
          # Skia static libraries (for linking)
          mkdir -p "$PKG_NAME/lib"
          SKIA_LIB_DIR="third_party/skia/skia/out/Release"
          for lib in skottie skia skparagraph sksg skshaper skunicode_icu skunicode_core skresources jsonreader; do
            if [ -f "$SKIA_LIB_DIR/lib${lib}.a" ]; then
              cp "$SKIA_LIB_DIR/lib${lib}.a" "$PKG_NAME/lib/"
            fi
          done
          
          # pkg-config file
          mkdir -p "$PKG_NAME/lib/pkgconfig"
          cat > "$PKG_NAME/lib/pkgconfig/lotio.pc" << EOF
          prefix=/usr/local
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${exec_prefix}/include
          
          Name: lotio
          Description: High-performance Lottie animation frame renderer using Skia
          Version: ${VERSION#v}
          Libs: -L\${libdir} -lskottie -lskia -lskparagraph -lsksg -lskshaper -lskunicode_icu -lskunicode_core -lskresources -ljsonreader
          Cflags: -I\${includedir}
          EOF
          
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          SHA256=$(shasum -a 256 "${PKG_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT

      - name: Create Homebrew bottle
        id: bottle
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # Create bottle directory structure
          BOTTLE_DIR="lotio-${VERSION_NUMBER}"
          mkdir -p "$BOTTLE_DIR/bin"
          mkdir -p "$BOTTLE_DIR/include/lotio/core"
          mkdir -p "$BOTTLE_DIR/include/lotio/text"
          mkdir -p "$BOTTLE_DIR/include/lotio/utils"
          mkdir -p "$BOTTLE_DIR/lib/pkgconfig"
          
          # Copy binary
          cp lotio "$BOTTLE_DIR/bin/"
          
          # Copy headers
          cp -r src/core/*.h "$BOTTLE_DIR/include/lotio/core/" 2>/dev/null || true
          cp -r src/text/*.h "$BOTTLE_DIR/include/lotio/text/" 2>/dev/null || true
          cp -r src/utils/*.h "$BOTTLE_DIR/include/lotio/utils/" 2>/dev/null || true
          
          # Copy Skia static libraries
          SKIA_LIB_DIR="third_party/skia/skia/out/Release"
          for lib in skottie skia skparagraph sksg skshaper skunicode_icu skunicode_core skresources jsonreader; do
            if [ -f "$SKIA_LIB_DIR/lib${lib}.a" ]; then
              cp "$SKIA_LIB_DIR/lib${lib}.a" "$BOTTLE_DIR/lib/"
            fi
          done
          
          # Create pkg-config file
          cat > "$BOTTLE_DIR/lib/pkgconfig/lotio.pc" << EOF
          prefix=/opt/homebrew
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${exec_prefix}/include
          
          Name: lotio
          Description: High-performance Lottie animation frame renderer using Skia
          Version: ${VERSION_NUMBER}
          Libs: -L\${libdir} -lskottie -lskia -lskparagraph -lsksg -lskshaper -lskunicode_icu -lskunicode_core -lskresources -ljsonreader
          Cflags: -I\${includedir}
          EOF
          
          # Create tarball (Homebrew bottle format)
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            BOTTLE_ARCH="arm64_big_sur"
          else
            BOTTLE_ARCH="x86_64_linux"
          fi
          
          tar -czf "lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" "$BOTTLE_DIR"
          
          SHA256=$(shasum -a 256 "lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" >> $GITHUB_OUTPUT
          echo "ARCH=$BOTTLE_ARCH" >> $GITHUB_OUTPUT

      - name: Create Git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use GITHUB_TOKEN for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          # Check if tag already exists
          if git rev-parse "${{ steps.version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "Tag ${{ steps.version.outputs.VERSION }} already exists, skipping"
          else
            git tag -a "${{ steps.version.outputs.VERSION }}" -m "Release ${{ steps.version.outputs.VERSION }}"
            git push origin "${{ steps.version.outputs.VERSION }}"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.dev_package.outputs.FILENAME }}
            ${{ steps.bottle.outputs.FILENAME }}
          name: Release ${{ steps.version.outputs.VERSION }}
          tag_name: ${{ steps.version.outputs.VERSION }}
          body: |
            ## Lotio ${{ steps.version.outputs.VERSION }}
            
            ### Packages
            
            **Developer package** (binary + headers + libraries for development):
            - File: \`${{ steps.dev_package.outputs.FILENAME }}\`
            - SHA256: \`${{ steps.dev_package.outputs.SHA256 }}\`
            - Contains: binary, lotio headers, Skia static libraries, pkg-config file
            
            **Homebrew bottle** (pre-built binary for macOS):
            - File: \`${{ steps.bottle.outputs.FILENAME }}\`
            - SHA256: \`${{ steps.bottle.outputs.SHA256 }}\`
            - Used automatically by Homebrew for fast installation
            
            **Debian package** (Linux ARM64):
            - File: \`lotio_${{ steps.version.outputs.VERSION }}_arm64.deb\`
            - Install: \`sudo dpkg -i lotio_${{ steps.version.outputs.VERSION }}_arm64.deb\`
            
            ### Installation
            
            **Homebrew (macOS) - Recommended:**
            \`\`\`bash
            brew tap matrunchyk/homebrew-lotio
            brew install lotio
            \`\`\`
            
            **Developer package (for programmatic use):**
            \`\`\`bash
            wget https://github.com/matrunchyk/lotio/releases/download/${{ steps.version.outputs.VERSION }}/${{ steps.dev_package.outputs.FILENAME }}
            tar -xzf ${{ steps.dev_package.outputs.FILENAME }}
            # Use binary, headers, and libraries from the package
            \`\`\`
            
            **Debian/Ubuntu (Linux ARM64):**
            \`\`\`bash
            wget https://github.com/matrunchyk/lotio/releases/download/${{ steps.version.outputs.VERSION }}/lotio_${{ steps.version.outputs.VERSION }}_arm64.deb
            sudo dpkg -i lotio_${{ steps.version.outputs.VERSION }}_arm64.deb
            \`\`\`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Formula
        continue-on-error: false
        uses: dawidd6/action-homebrew-bump-formula@v7
        with:
          formula: lotio
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          tap: matrunchyk/homebrew-lotio
          tag: ${{ steps.version.outputs.VERSION }}
          message: "Update lotio to ${{ steps.version.outputs.VERSION }}"

  build-linux-deb:
    runs-on: ubuntu-latest  # Note: ubuntu-latest is x86_64, not ARM64
    needs: build-and-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from macOS job
        id: version
        run: |
          VERSION="${{ needs.build-and-release.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            ninja-build \
            python3 \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            mesa-common-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libpng-dev \
            libjpeg-dev \
            libicu-dev \
            libharfbuzz-dev \
            libwebp-dev \
            dpkg-dev

      - name: Cache Skia
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: third_party/skia/skia
          key: skia-linux-${{ runner.os }}-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            skia-linux-${{ runner.os }}-

      - name: Fetch Skia
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          mkdir -p third_party/skia
          cd third_party/skia
          # Remove existing directory if it exists (from partial cache or previous runs)
          rm -rf skia
          git config --global advice.detachedHead false
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          chmod +x "$GITHUB_WORKSPACE/sync_skia_deps.sh"
          "$GITHUB_WORKSPACE/sync_skia_deps.sh" .
          echo "Skia cloned and dependencies synced successfully"

      - name: Cache Skia Build
        id: cache-skia-build
        uses: actions/cache@v4
        with:
          path: third_party/skia/skia/out/Release
          key: skia-build-linux-${{ runner.os }}-${{ hashFiles('install_skia.sh') }}
          restore-keys: |
            skia-build-linux-${{ runner.os }}-

      - name: Build Skia
        if: steps.cache-skia-build.outputs.cache-hit != 'true'
        run: |
          chmod +x install_skia.sh
          ./install_skia.sh

      - name: Build lotio
        run: |
          chmod +x build_local.sh
          ./build_local.sh

      - name: Test binary
        run: |
          ./lotio --help

      - name: Create .deb package
        id: deb_package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio"
          PKG_VERSION="${VERSION#v}"
          DEB_DIR="deb-package"
          
          mkdir -p "$DEB_DIR/usr/local/bin"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/core"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/text"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/utils"
          mkdir -p "$DEB_DIR/DEBIAN"
          
          cp lotio "$DEB_DIR/usr/local/bin/"
          cp src/core/*.h "$DEB_DIR/usr/local/include/lotio/core/" 2>/dev/null || true
          cp src/text/*.h "$DEB_DIR/usr/local/include/lotio/text/" 2>/dev/null || true
          cp src/utils/*.h "$DEB_DIR/usr/local/include/lotio/utils/" 2>/dev/null || true
          
          cat > "$DEB_DIR/DEBIAN/control" << EOF
          Package: lotio
          Version: ${PKG_VERSION}
          Architecture: arm64
          Maintainer: matrunchyk
          Description: High-performance Lottie animation frame renderer using Skia
           Render Lottie animations frame-by-frame to PNG and/or WebP files for video encoding.
          Depends: libfontconfig1, libfreetype6, libx11-6, libxext6, libxrender1, libpng16-16, libjpeg-turbo8, libicu70, libharfbuzz0b, libwebp7
          EOF
          
          cat > "$DEB_DIR/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          set -e
          if command -v fc-cache >/dev/null 2>&1; then
            fc-cache -f >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod +x "$DEB_DIR/DEBIAN/postinst"
          
          dpkg-deb --build "$DEB_DIR" "${PKG_NAME}_${PKG_VERSION}_arm64.deb"
          
          SHA256=$(shasum -a 256 "${PKG_NAME}_${PKG_VERSION}_arm64.deb" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}_${PKG_VERSION}_arm64.deb" >> $GITHUB_OUTPUT

      - name: Upload .deb to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.deb_package.outputs.FILENAME }}
          tag_name: ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
