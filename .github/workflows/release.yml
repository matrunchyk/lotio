name: Build, Package and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          # Check if we're on a semantic version tag (v1.1.0, v2.0.0, etc.)
          if git describe --tags --exact-match HEAD 2>/dev/null | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
            # Use the semantic version tag
            VERSION=$(git describe --tags --exact-match HEAD)
            echo "Using semantic version tag: $VERSION"
          else
            # Fall back to date-SHA format
            DATE=$(date +%Y%m%d)
            SHA=$(git rev-parse --short HEAD)
            VERSION="v${DATE}-${SHA}"
            echo "Using date-SHA version: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          # Extract version number for Homebrew (remove 'v' prefix)
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install dependencies
        run: |
          brew install fontconfig freetype harfbuzz icu4c libpng jpeg-turbo webp ninja python@3.11

      - name: Fetch Skia
        run: |
          mkdir -p third_party/skia
          cd third_party/skia
          rm -rf skia
          git config --global advice.detachedHead false
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          chmod +x "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh"
          "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh" .
          echo "Skia cloned and dependencies synced successfully"

      - name: Build Skia
        run: |
          chmod +x scripts/install_skia.sh
          ./scripts/install_skia.sh

      - name: Build lotio
        run: |
          chmod +x scripts/build_local.sh
          ./scripts/build_local.sh

      - name: Test binary
        run: |
          ./lotio --help

      - name: Create developer package
        id: dev_package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio-dev-${VERSION}"
          mkdir -p "$PKG_NAME"
          
          # Binary
          cp lotio "$PKG_NAME/"
          
          # Headers (for development)
          mkdir -p "$PKG_NAME/include/lotio/core"
          mkdir -p "$PKG_NAME/include/lotio/text"
          mkdir -p "$PKG_NAME/include/lotio/utils"
          cp src/core/*.h "$PKG_NAME/include/lotio/core/"
          cp src/text/*.h "$PKG_NAME/include/lotio/text/"
          cp src/utils/*.h "$PKG_NAME/include/lotio/utils/"
          
          # Skia static libraries (for linking)
          mkdir -p "$PKG_NAME/lib"
          SKIA_LIB_DIR="third_party/skia/skia/out/Release"
          for lib in skottie skia skparagraph sksg skshaper skunicode_icu skunicode_core skresources jsonreader; do
            if [ -f "$SKIA_LIB_DIR/lib${lib}.a" ]; then
              cp "$SKIA_LIB_DIR/lib${lib}.a" "$PKG_NAME/lib/"
            fi
          done
          
          # pkg-config file
          mkdir -p "$PKG_NAME/lib/pkgconfig"
          cat > "$PKG_NAME/lib/pkgconfig/lotio.pc" << EOF
          prefix=/usr/local
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${exec_prefix}/include
          
          Name: lotio
          Description: High-performance Lottie animation frame renderer using Skia
          Version: ${VERSION#v}
          Libs: -L\${libdir} -lskottie -lsksg -ljsonreader -lskia -lskparagraph -lskshaper -lskunicode_icu -lskunicode_core -lskresources
          Cflags: -I\${includedir}
          EOF
          
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          SHA256=$(shasum -a 256 "${PKG_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT

      - name: Create Homebrew bottle
        id: bottle
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # Determine Homebrew prefix based on architecture
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            BOTTLE_ARCH="arm64_big_sur"
            HOMEBREW_PREFIX="/opt/homebrew"
          else
            BOTTLE_ARCH="x86_64_linux"
            HOMEBREW_PREFIX="/usr/local"
          fi
          
          # Create bottle directory structure with Homebrew prefix
          # Structure: lotio/<version>/<prefix>/bin, etc.
          BOTTLE_DIR="lotio/${VERSION_NUMBER}${HOMEBREW_PREFIX}"
          mkdir -p "$BOTTLE_DIR/bin"
          mkdir -p "$BOTTLE_DIR/include/lotio/core"
          mkdir -p "$BOTTLE_DIR/include/lotio/text"
          mkdir -p "$BOTTLE_DIR/include/lotio/utils"
          mkdir -p "$BOTTLE_DIR/lib/pkgconfig"
          
          # Copy binary
          cp lotio "$BOTTLE_DIR/bin/"
          
          # Copy headers
          cp src/core/*.h "$BOTTLE_DIR/include/lotio/core/"
          cp src/text/*.h "$BOTTLE_DIR/include/lotio/text/"
          cp src/utils/*.h "$BOTTLE_DIR/include/lotio/utils/"
          
          # Copy Skia static libraries
          SKIA_LIB_DIR="third_party/skia/skia/out/Release"
          for lib in skottie skia skparagraph sksg skshaper skunicode_icu skunicode_core skresources jsonreader; do
            if [ -f "$SKIA_LIB_DIR/lib${lib}.a" ]; then
              cp "$SKIA_LIB_DIR/lib${lib}.a" "$BOTTLE_DIR/lib/"
            fi
          done
          
          # Create pkg-config file with relocatable prefix
          cat > "$BOTTLE_DIR/lib/pkgconfig/lotio.pc" << EOF
          prefix=\${pcfiledir}/../..
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${exec_prefix}/include
          
          Name: lotio
          Description: High-performance Lottie animation frame renderer using Skia
          Version: ${VERSION_NUMBER}
          Libs: -L\${libdir} -lskottie -lskia -lskparagraph -lsksg -lskshaper -lskunicode_icu -lskunicode_core -lskresources -ljsonreader
          Cflags: -I\${includedir}
          EOF
          
          # Create tarball (Homebrew bottle format)
          # The tarball should contain: lotio/<version>/<prefix>/...
          tar -czf "lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" "lotio"
          
          SHA256=$(shasum -a 256 "lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=lotio-${VERSION_NUMBER}.${BOTTLE_ARCH}.bottle.tar.gz" >> $GITHUB_OUTPUT
          echo "ARCH=$BOTTLE_ARCH" >> $GITHUB_OUTPUT

      - name: Create Git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Configure git to use GITHUB_TOKEN for authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          # Check if tag already exists
          if git rev-parse "${{ steps.version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "Tag ${{ steps.version.outputs.VERSION }} already exists, skipping"
          else
            git tag -a "${{ steps.version.outputs.VERSION }}" -m "Release ${{ steps.version.outputs.VERSION }}"
            git push origin "${{ steps.version.outputs.VERSION }}"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.dev_package.outputs.FILENAME }}
            ${{ steps.bottle.outputs.FILENAME }}
          name: Release ${{ steps.version.outputs.VERSION }}
          tag_name: ${{ steps.version.outputs.VERSION }}
          body: |
            ## Lotio ${{ steps.version.outputs.VERSION }}
            
            ### Packages
            
            **Developer package** (binary + headers + libraries for development):
            - File: `{{ steps.dev_package.outputs.FILENAME }}`
            - SHA256: `{{ steps.dev_package.outputs.SHA256 }}`
            - Contains: binary, lotio headers, Skia static libraries, pkg-config file
            
            **Homebrew bottle** (pre-built binary for macOS):
            - File: `{{ steps.bottle.outputs.FILENAME }}`
            - SHA256: `{{ steps.bottle.outputs.SHA256 }}`
            - Used automatically by Homebrew for fast installation
            
            **Debian package** (Linux ARM64):
            - File: `lotio_${{ steps.version.outputs.VERSION }}_arm64.deb`
            - Install: `sudo dpkg -i lotio_${{ steps.version.outputs.VERSION }}_arm64.deb`
            
            **WebAssembly package** (for browser use):
            - File: `lotio-wasm-${{ steps.version.outputs.VERSION }}.tar.gz`
            - Contains: `lotio.wasm`, `lotio.js`, `lotio_wasm.js`
            - See package README for usage instructions
            
            ### Installation
            
            **Homebrew (macOS) - Recommended:**
            ```bash
            brew tap matrunchyk/homebrew-lotio
            brew install lotio
            ```
            
            **Developer package (for programmatic use):**
            ```bash
            wget https://github.com/matrunchyk/lotio/releases/download/${{ steps.version.outputs.VERSION }}/${{ steps.dev_package.outputs.FILENAME }}
            tar -xzf ${{ steps.dev_package.outputs.FILENAME }}
            # Use binary, headers, and libraries from the package
            ```
            
            **Debian/Ubuntu (Linux ARM64):**
            ```bash
            wget https://github.com/matrunchyk/lotio/releases/download/${{ steps.version.outputs.VERSION }}/lotio_${{ steps.version.outputs.VERSION }}_arm64.deb
            sudo dpkg -i lotio_${{ steps.version.outputs.VERSION }}_arm64.deb
            ```
            
            **WebAssembly (Browser):**
            ```bash
            wget https://github.com/matrunchyk/lotio/releases/download/${{ steps.version.outputs.VERSION }}/lotio-wasm-${{ steps.version.outputs.VERSION }}.tar.gz
            tar -xzf lotio-wasm-${{ steps.version.outputs.VERSION }}.tar.gz
            # Use lotio_wasm.js in your web application
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get source archive SHA256
        id: source_sha
        run: |
          # Create source archive from current checkout (matches GitHub's auto-generated archive)
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          # Create archive matching GitHub's format: lotio-<version>.tar.gz
          tar --exclude='.git' --exclude='third_party/skia' -czf "lotio-${VERSION_NUMBER}.tar.gz" .
          SHA256=$(shasum -a 256 "lotio-${VERSION_NUMBER}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          rm -f "lotio-${VERSION_NUMBER}.tar.gz"

      - name: Update Homebrew Formula
        if: steps.version.outputs.VERSION != ''
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          chmod +x scripts/update_homebrew_formula.sh
          export HOMEBREW_TAP_TOKEN="${{ secrets.HOMEBREW_TAP_TOKEN }}"
          ./scripts/update_homebrew_formula.sh \
            "${{ steps.version.outputs.VERSION }}" \
            "${{ steps.source_sha.outputs.SHA256 }}" \
            "${{ steps.bottle.outputs.SHA256 }}" \
            "${{ steps.bottle.outputs.ARCH }}"

  build-linux-deb:
    runs-on: ubuntu-latest  # Note: ubuntu-latest is x86_64, not ARM64
    needs: build-and-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from macOS job
        id: version
        run: |
          VERSION="${{ needs.build-and-release.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            ninja-build \
            python3 \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            mesa-common-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libpng-dev \
            libjpeg-dev \
            libicu-dev \
            libharfbuzz-dev \
            libwebp-dev \
            dpkg-dev

      - name: Fetch Skia
        run: |
          mkdir -p third_party/skia
          cd third_party/skia
          rm -rf skia
          git config --global advice.detachedHead false
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          chmod +x "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh"
          "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh" .
          echo "Skia cloned and dependencies synced successfully"

      - name: Build Skia
        run: |
          chmod +x scripts/install_skia.sh
          ./scripts/install_skia.sh

      - name: Build lotio
        run: |
          chmod +x scripts/build_local.sh
          ./scripts/build_local.sh

      - name: Test binary
        run: |
          ./lotio --help

      - name: Create .deb package
        id: deb_package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio"
          PKG_VERSION="${VERSION#v}"
          DEB_DIR="deb-package"
          
          mkdir -p "$DEB_DIR/usr/local/bin"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/core"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/text"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/utils"
          mkdir -p "$DEB_DIR/DEBIAN"
          
          cp lotio "$DEB_DIR/usr/local/bin/"
          cp src/core/*.h "$DEB_DIR/usr/local/include/lotio/core/"
          cp src/text/*.h "$DEB_DIR/usr/local/include/lotio/text/"
          cp src/utils/*.h "$DEB_DIR/usr/local/include/lotio/utils/"
          
          cat > "$DEB_DIR/DEBIAN/control" << EOF
          Package: lotio
          Version: ${PKG_VERSION}
          Architecture: arm64
          Maintainer: matrunchyk
          Description: High-performance Lottie animation frame renderer using Skia
           Render Lottie animations frame-by-frame to PNG and/or WebP files for video encoding.
          Depends: libfontconfig1, libfreetype6, libx11-6, libxext6, libxrender1, libpng16-16, libjpeg-turbo8, libicu70, libharfbuzz0b, libwebp7
          EOF
          
          cat > "$DEB_DIR/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          set -e
          if command -v fc-cache >/dev/null 2>&1; then
            fc-cache -f >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod +x "$DEB_DIR/DEBIAN/postinst"
          
          dpkg-deb --build "$DEB_DIR" "${PKG_NAME}_${PKG_VERSION}_arm64.deb"
          
          SHA256=$(shasum -a 256 "${PKG_NAME}_${PKG_VERSION}_arm64.deb" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}_${PKG_VERSION}_arm64.deb" >> $GITHUB_OUTPUT

      - name: Upload .deb to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.deb_package.outputs.FILENAME }}
          tag_name: ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-latest
    needs: build-and-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version from macOS job
        id: version
        run: |
          VERSION="${{ needs.build-and-release.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Install Emscripten
        uses: mymindstorm/setup-emsdk@v12
        with:
          version: latest
          actions-cache-folder: '.emsdk-cache'

      - name: Fetch Skia
        run: |
          mkdir -p third_party/skia
          cd third_party/skia
          rm -rf skia
          git config --global advice.detachedHead false
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          chmod +x "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh"
          "$GITHUB_WORKSPACE/scripts/sync_skia_deps.sh" .
          echo "Skia cloned and dependencies synced successfully"

      - name: Build Skia for WASM
        run: |
          chmod +x scripts/build_skia_wasm.sh
          ./scripts/build_skia_wasm.sh

      - name: Build lotio WASM
        run: |
          chmod +x scripts/build_wasm.sh
          ./scripts/build_wasm.sh

      - name: Create WASM package
        id: wasm_package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio-wasm-${VERSION}"
          mkdir -p "$PKG_NAME"
          
          # Copy library files
          cp -r browser "$PKG_NAME/"
          
          # Create README
          cat > "$PKG_NAME/README.md" << EOF
          # Lotio WebAssembly Package
          
          Version: ${VERSION}
          
          ## Files
          - \`lotio.wasm\` - WebAssembly binary
          - \`lotio.js\` - Emscripten loader
          - \`lotio_wasm.js\` - JavaScript wrapper API
          
          ## Usage
          
          \`\`\`javascript
          import { initLotio, createAnimation, renderFrameToCanvas } from './lotio_wasm.js';
          
          await initLotio('./lotio.wasm');
          const info = createAnimation(jsonData);
          renderFrameToCanvas(canvas, 0.5);
          \`\`\`
          
          See the full API in \`lotio_wasm.js\`.
          EOF
          
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          SHA256=$(shasum -a 256 "${PKG_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT

      - name: Upload WASM to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.wasm_package.outputs.FILENAME }}
            browser/
          tag_name: ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # Update package.json version
          npm version $VERSION_NUMBER --no-git-tag-version
          
          # Copy necessary files for npm package
          mkdir -p npm-package
          cp -r browser npm-package/
          cp package.json npm-package/
          cp README.md npm-package/
          
          cd npm-package
          
          # Configure npm for GitHub Packages
          echo "@matrunchyk:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
          
          # Publish to GitHub Packages
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
