name: Build, Package and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: true

jobs:
  version-and-tag:
    name: Version and Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      version_number: ${{ steps.version.outputs.VERSION_NUMBER }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version
        id: version
        run: |
          # Check if we're on a semantic version tag (v1.1.0, v2.0.0, etc.)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag
            VERSION="${{ github.ref_name }}"
            # Validate it's semver format
            if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
              echo "❌ Error: Tag $VERSION is not in semver format (v1.2.3)"
              exit 1
            fi
            echo "Using semantic version tag: $VERSION"
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # On main branch - create new semver tag
            # Get latest tag
            LATEST_TAG=$(git describe --tags --match 'v*.*.*' --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "Latest tag: $LATEST_TAG"
            
            # Extract version numbers
            if [[ "$LATEST_TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              PATCH="${BASH_REMATCH[3]}"
              # Bump patch version
              PATCH=$((PATCH + 1))
              VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            else
              # No valid tag found, start at v1.0.0
              VERSION="v1.0.0"
            fi
            
            echo "Creating new semantic version tag: $VERSION"
            
            # Create and push tag
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$VERSION" -m "Release $VERSION" || {
              # Tag might already exist
              if git rev-parse "$VERSION" >/dev/null 2>&1; then
                echo "Tag $VERSION already exists, using it"
              else
                echo "❌ Failed to create tag"
                exit 1
              fi
            }
            git push origin "$VERSION"
          else
            echo "❌ Error: This workflow should only run on main branch or version tags"
            exit 1
          fi
          
          VERSION_NUMBER="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (number: $VERSION_NUMBER)"

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: version-and-tag
    outputs:
      dev_package_filename: ${{ steps.dev_package.outputs.FILENAME }}
      dev_package_sha256: ${{ steps.dev_package.outputs.SHA256 }}
      bottle_filename: ${{ steps.bottle.outputs.FILENAME }}
      bottle_sha256: ${{ steps.bottle.outputs.SHA256 }}
      bottle_arch: ${{ steps.bottle.outputs.ARCH }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          brew install fontconfig freetype harfbuzz icu4c libpng ninja python@3.11

      - name: Build lotio
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          chmod +x scripts/build_binary.sh
          # Pass version to build script via environment
          ./scripts/build_binary.sh

      - name: Test binary
        run: |
          ./lotio --help
          ./lotio --version

      - name: Create developer package
        id: dev_package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio-dev-${VERSION}"
          mkdir -p "$PKG_NAME"
          
          # Binary
          cp lotio "$PKG_NAME/"
          
          # Headers (for development)
          mkdir -p "$PKG_NAME/include/lotio/core"
          mkdir -p "$PKG_NAME/include/lotio/text"
          mkdir -p "$PKG_NAME/include/lotio/utils"
          cp src/core/*.h "$PKG_NAME/include/lotio/core/"
          cp src/text/*.h "$PKG_NAME/include/lotio/text/"
          cp src/utils/*.h "$PKG_NAME/include/lotio/utils/"
          
          # Skia headers (for developers to use Skia directly)
          SKIA_ROOT="third_party/skia"
          SKIA_INCLUDE_DIR="$SKIA_ROOT/include"
          SKIA_MODULES_DIR="$SKIA_ROOT/modules"
          SKIA_GEN_DIR="$SKIA_ROOT/out/Release/gen"
          
          # Copy main Skia headers
          if [ -d "$SKIA_INCLUDE_DIR" ]; then
            mkdir -p "$PKG_NAME/include/skia"
            cp -r "$SKIA_INCLUDE_DIR"/* "$PKG_NAME/include/skia/" 2>/dev/null || true
          fi
          
          # Copy module headers
          if [ -d "$SKIA_MODULES_DIR" ]; then
            for module in skottie skparagraph sksg skshaper skunicode skresources jsonreader; do
              if [ -d "$SKIA_MODULES_DIR/$module/include" ]; then
                mkdir -p "$PKG_NAME/include/skia/modules/$module"
                cp -r "$SKIA_MODULES_DIR/$module/include"/* "$PKG_NAME/include/skia/modules/$module/" 2>/dev/null || true
              fi
            done
          fi
          
          # Copy generated headers
          if [ -d "$SKIA_GEN_DIR" ]; then
            mkdir -p "$PKG_NAME/include/skia/gen"
            cp -r "$SKIA_GEN_DIR"/*.h "$PKG_NAME/include/skia/gen/" 2>/dev/null || true
          fi
          
          # liblotio.a library
          mkdir -p "$PKG_NAME/lib"
          if [ -f "liblotio.a" ]; then
            cp liblotio.a "$PKG_NAME/lib/"
          else
            echo "⚠️  Warning: liblotio.a not found"
          fi
          
          # Skia static libraries (for linking)
          SKIA_LIB_DIR="third_party/skia/out/Release"
          for lib in skottie skia skparagraph sksg skshaper skunicode_icu skunicode_core skresources jsonreader; do
            if [ -f "$SKIA_LIB_DIR/lib${lib}.a" ] || [ -f "$SKIA_LIB_DIR/lib${lib}.dylib" ]; then
              cp "$SKIA_LIB_DIR/lib${lib}".* "$PKG_NAME/lib/" 2>/dev/null || true
            fi
          done
          
          # pkg-config file
          mkdir -p "$PKG_NAME/lib/pkgconfig"
          cat > "$PKG_NAME/lib/pkgconfig/lotio.pc" << EOF
          prefix=/usr/local
          exec_prefix=\${prefix}
          libdir=\${exec_prefix}/lib
          includedir=\${exec_prefix}/include
          
          Name: lotio
          Description: High-performance Lottie animation frame renderer using Skia
          Version: ${VERSION#v}
          Libs: -L\${libdir} -llotio -lskottie -lsksg -ljsonreader -lskia -lskparagraph -lskshaper -lskunicode_icu -lskunicode_core -lskresources
          Cflags: -I\${includedir} -I\${includedir}/skia -I\${includedir}/skia/gen
          EOF
          
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          SHA256=$(shasum -a 256 "${PKG_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT

      - name: Create Homebrew bottle
        id: bottle
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          chmod +x scripts/create_bottle.sh
          ./scripts/create_bottle.sh "${{ steps.version.outputs.VERSION }}"

      - name: Get source archive SHA256
        id: source_sha
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          # Create archive matching GitHub's format: lotio-<version>.tar.gz
          tar --exclude='.git' --exclude='third_party/skia' -czf "lotio-${VERSION_NUMBER}.tar.gz" .
          SHA256=$(shasum -a 256 "lotio-${VERSION_NUMBER}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          rm -f "lotio-${VERSION_NUMBER}.tar.gz"

      - name: Update Homebrew Formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          chmod +x scripts/update_homebrew_formula.sh
          export HOMEBREW_TAP_TOKEN="${{ secrets.HOMEBREW_TAP_TOKEN }}"
          ./scripts/update_homebrew_formula.sh \
            "${{ steps.version.outputs.VERSION }}" \
            "${{ steps.source_sha.outputs.SHA256 }}" \
            "${{ steps.bottle.outputs.SHA256 }}" \
            "${{ steps.bottle.outputs.ARCH }}"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            ${{ steps.dev_package.outputs.FILENAME }}
            ${{ steps.bottle.outputs.FILENAME }}
          retention-days: 30

  build-docker-base:
    name: Build Docker Base Images
    runs-on: ubuntu-latest
    needs: version-and-tag
    strategy:
      matrix:
        variant: [lotio, lotio-al2023]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push ${{ matrix.variant }} image (multi-platform)
        uses: docker/build-push-action@v5
        id: build-base
        with:
          context: .
          file: ./Dockerfile.${{ matrix.variant }}
          platforms: linux/arm64,linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: |
            matrunchyk/${{ matrix.variant }}:${{ steps.version.outputs.VERSION }}
            matrunchyk/${{ matrix.variant }}:latest
          cache-from: |
            type=registry,ref=matrunchyk/${{ matrix.variant }}:latest
            type=gha
          cache-to: |
            type=gha,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILDKIT_INLINE_CACHE=1

      - name: Verify multi-platform manifest
        if: steps.build-base.outcome == 'success'
        run: |
          docker buildx imagetools inspect matrunchyk/${{ matrix.variant }}:latest

  build-docker-ffmpeg:
    name: Build Docker FFmpeg Images
    runs-on: ubuntu-latest
    needs: [version-and-tag, build-docker-base]
    strategy:
      matrix:
        variant: [lotio, lotio-al2023]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push ${{ matrix.variant }}-ffmpeg image (multi-platform)
        uses: docker/build-push-action@v5
        id: build-ffmpeg
        with:
          context: .
          file: ./Dockerfile.${{ matrix.variant }}-ffmpeg
          platforms: linux/arm64,linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: |
            matrunchyk/${{ matrix.variant }}-ffmpeg:${{ steps.version.outputs.VERSION }}
            matrunchyk/${{ matrix.variant }}-ffmpeg:latest
          cache-from: |
            type=registry,ref=matrunchyk/${{ matrix.variant }}-ffmpeg:latest
            type=gha
          cache-to: |
            type=gha,mode=max
          build-args: |
            LOTIO_IMAGE=matrunchyk/${{ matrix.variant }}:${{ steps.version.outputs.VERSION }}
            BUILDKIT_INLINE_CACHE=1

      - name: Verify multi-platform manifest
        if: steps.build-ffmpeg.outcome == 'success'
        run: |
          docker buildx imagetools inspect matrunchyk/${{ matrix.variant }}-ffmpeg:latest

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [version-and-tag, build-docker-ffmpeg]
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Create .deb package
        id: deb_package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          ARCH: ${{ matrix.arch }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCH="${{ matrix.arch }}"
          PKG_NAME="lotio"
          PKG_VERSION="${VERSION#v}"
          DEB_DIR="deb-package-${ARCH}"
          
          mkdir -p "$DEB_DIR/usr/local/bin"
          mkdir -p "$DEB_DIR/usr/local/lib"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/core"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/text"
          mkdir -p "$DEB_DIR/usr/local/include/lotio/utils"
          mkdir -p "$DEB_DIR/DEBIAN"
          
          # Extract binary and library from Docker image (specify platform for extraction)
          echo "Extracting binary from Docker image matrunchyk/lotio:${VERSION} (platform: linux/${ARCH})..."
          docker create --name lotio-extract --platform linux/${ARCH} "matrunchyk/lotio:${VERSION}"
          
          # Verify files exist in container before extraction
          echo "Verifying files exist in Docker image..."
          docker run --rm --platform linux/${ARCH} --entrypoint sh "matrunchyk/lotio:${VERSION}" -c "
            echo '=== /usr/local/bin ==='
            ls -la /usr/local/bin/
            echo '=== /usr/local/lib ==='
            ls -la /usr/local/lib/
            echo '=== /opt/skia ==='
            ls -la /opt/skia/
            test -f /usr/local/bin/lotio
            test -f /usr/local/lib/liblotio.a
            test -d /opt/skia/include
            test -d /opt/skia/modules
          "
          
          # Copy binary
          docker cp lotio-extract:/usr/local/bin/lotio "$DEB_DIR/usr/local/bin/"
          
          # Copy library
          docker cp lotio-extract:/usr/local/lib/liblotio.a "$DEB_DIR/usr/local/lib/"
          
          # Extract Skia headers
          echo "Extracting Skia headers from Docker image..."
          docker cp lotio-extract:/opt/skia/include "$DEB_DIR/usr/local/include/skia"
          docker cp lotio-extract:/opt/skia/modules "$DEB_DIR/usr/local/include/skia/"
          
          # Skia gen directory - check if it exists before copying
          if docker run --rm --platform linux/${ARCH} --entrypoint sh "matrunchyk/lotio:${VERSION}" -c "test -d /opt/skia/gen"; then
            docker cp lotio-extract:/opt/skia/gen "$DEB_DIR/usr/local/include/skia/"
          else
            echo "Note: Skia gen directory not present (this is normal for some build configurations)"
          fi
          
          docker rm lotio-extract
          
          # Copy lotio headers from source
          cp src/core/*.h "$DEB_DIR/usr/local/include/lotio/core/"
          cp src/text/*.h "$DEB_DIR/usr/local/include/lotio/text/"
          cp src/utils/*.h "$DEB_DIR/usr/local/include/lotio/utils/"
          
          # Create control file
          cat > "$DEB_DIR/DEBIAN/control" << EOF
          Package: lotio
          Version: ${PKG_VERSION}
          Architecture: ${ARCH}
          Maintainer: matrunchyk
          Description: High-performance Lottie animation frame renderer using Skia
           Render Lottie animations frame-by-frame to PNG files for video encoding.
          Depends: libfontconfig1, libfreetype6, libpng16-16, libicu70, libharfbuzz0b, zlib1g, libexpat1
          EOF
          
          # Create postinst script
          cat > "$DEB_DIR/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          set -e
          if command -v fc-cache >/dev/null 2>&1; then
            fc-cache -f >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod +x "$DEB_DIR/DEBIAN/postinst"
          
          # Build .deb package
          dpkg-deb --build "$DEB_DIR" "${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb"
          
          SHA256=$(shasum -a 256 "${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb" | cut -d' ' -f1)
          
          # Save metadata and artifacts
          mkdir -p metadata artifacts
          echo "FILENAME=${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb" > "metadata/${ARCH}.txt"
          echo "SHA256=${SHA256}" >> "metadata/${ARCH}.txt"
          cp "${PKG_NAME}_${PKG_VERSION}_${ARCH}.deb" artifacts/

      - name: Upload .deb packages and metadata
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ matrix.arch }}
          path: |
            artifacts/*.deb
            metadata/${{ matrix.arch }}.txt
          retention-days: 30

  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-latest
    needs: version-and-tag
    outputs:
      wasm_package_filename: ${{ steps.wasm_package.outputs.FILENAME }}
      wasm_package_sha256: ${{ steps.wasm_package.outputs.SHA256 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Emscripten
        uses: mymindstorm/setup-emsdk@v12
        with:
          version: latest
          no-cache: true

      - name: Build lotio WASM
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          chmod +x scripts/build_wasm.sh
          ./scripts/build_wasm.sh

      - name: Create WASM package
        id: wasm_package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PKG_NAME="lotio-wasm-${VERSION}"
          mkdir -p "$PKG_NAME"
          
          # Copy library files
          cp -r browser "$PKG_NAME/"
          
          # Create README
          cat > "$PKG_NAME/README.md" << EOF
          # Lotio WebAssembly Package
          
          Version: ${VERSION}
          
          ## Files
          - \`lotio.wasm\` - WebAssembly binary
          - \`lotio.js\` - Emscripten loader
          - \`lotio_wasm.js\` - JavaScript wrapper API
          
          ## Usage
          
          \`\`\`javascript
          import { initLotio, createAnimation, renderFrameToCanvas } from './lotio_wasm.js';
          
          await initLotio('./lotio.wasm');
          const info = createAnimation(jsonData);
          renderFrameToCanvas(canvas, 0.5);
          \`\`\`
          
          See the full API in \`lotio_wasm.js\`.
          EOF
          
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          SHA256=$(shasum -a 256 "${PKG_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "FILENAME=${PKG_NAME}.tar.gz" >> $GITHUB_OUTPUT

      - name: Upload WASM package artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-package
          path: ${{ steps.wasm_package.outputs.FILENAME }}
          retention-days: 30

      - name: Publish to GitHub Packages
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          
          # Copy necessary files for npm package
          mkdir -p npm-package
          cp -r browser npm-package/
          cp README.md npm-package/ 2>/dev/null || echo "# Lotio" > npm-package/README.md
          
          cd npm-package
          
          # Create package.json if it doesn't exist
          if [ ! -f "../package.json" ]; then
            cat > package.json << EOF
          {
            "name": "@matrunchyk/lotio",
            "version": "${VERSION_NUMBER}",
            "description": "High-performance Lottie animation frame renderer for the browser",
            "main": "browser/lotio.js",
            "module": "browser/lotio.js",
            "types": "browser/lotio.d.ts",
            "files": [
              "browser"
            ],
            "repository": {
              "type": "git",
              "url": "https://github.com/matrunchyk/lotio.git"
            },
            "keywords": [
              "lottie",
              "animation",
              "renderer",
              "skia",
              "webassembly",
              "wasm"
            ],
            "author": "matrunchyk",
            "license": "MIT",
            "publishConfig": {
              "registry": "https://npm.pkg.github.com"
            }
          }
          EOF
          else
            cp ../package.json package.json
            # Update version in package.json
            if echo "$VERSION_NUMBER" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
              NEW_VERSION="$VERSION_NUMBER"
            else
              NEW_VERSION="0.0.0-${VERSION_NUMBER}"
            fi
            
            # Update version in package.json
            if command -v jq >/dev/null 2>&1; then
              jq ".version = \"$NEW_VERSION\"" package.json > package.json.tmp && mv package.json.tmp package.json
            else
              sed -i.bak "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" package.json
              rm -f package.json.bak
            fi
          fi
          
          echo "Using package.json version: $(grep -o '"version": "[^"]*"' package.json | head -1)"
          
          # Configure npm for GitHub Packages
          echo "@matrunchyk:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
          
          # Publish to GitHub Packages
          npm publish

  build-docs:
    runs-on: ubuntu-latest
    needs: [version-and-tag, build-wasm]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 git
          pip install markdown

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure npm for GitHub Packages
        run: |
          echo "@matrunchyk:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc

      - name: Install lotio npm package
        run: |
          npm install @matrunchyk/lotio

      - name: Build documentation
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          chmod +x scripts/build_docs.py
          python3 scripts/build_docs.py

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  test-artifacts:
    runs-on: ubuntu-latest
    needs: [version-and-tag, build-docker-ffmpeg, build-wasm]
    strategy:
      matrix:
        test: [docker, js-wasm]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Test Docker image
        if: matrix.test == 'docker'
        run: |
          docker pull matrunchyk/lotio:${{ steps.version.outputs.VERSION }}
          docker run --rm matrunchyk/lotio:${{ steps.version.outputs.VERSION }} --help
          docker run --rm matrunchyk/lotio:${{ steps.version.outputs.VERSION }} --version
          
          # Test basic functionality
          echo '{"v":"5.5.2","fr":30,"w":100,"h":100,"ip":0,"op":30,"layers":[]}' > /tmp/test.json
          mkdir -p /tmp/output
          docker run --rm \
            -v /tmp/test.json:/workspace/test.json:ro \
            -v /tmp/output:/workspace/output \
            matrunchyk/lotio:${{ steps.version.outputs.VERSION }} \
            /workspace/test.json /workspace/output 30

      - name: Setup Node.js
        if: matrix.test == 'js-wasm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure npm for GitHub Packages
        if: matrix.test == 'js-wasm'
        run: |
          echo "@matrunchyk:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc

      - name: Test JS/WASM library
        if: matrix.test == 'js-wasm'
        run: |
          # Install and test (package should be published by build-wasm job)
          npm install @matrunchyk/lotio
          node -e "import('@matrunchyk/lotio').then(m => console.log('✅ Library loaded:', Object.keys(m))).catch(e => {console.error('❌ Failed:', e); process.exit(1)})"

  publish-release:
    runs-on: ubuntu-latest
    needs: [version-and-tag, build-macos, build-linux, build-wasm, build-docs, build-docker-ffmpeg, test-artifacts]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Read package metadata and generate release body
        id: release_metadata
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          
          # Get commit messages since the previous tag
          # First, get all tags sorted by version
          ALL_TAGS=$(git tag --list 'v*.*.*' --sort=-version:refname)
          
          # Find the current tag in the list
          CURRENT_TAG="$VERSION"
          PREVIOUS_TAG=""
          
          # Find the tag that comes before the current one
          FOUND_CURRENT=false
          for tag in $ALL_TAGS; do
            if [ "$FOUND_CURRENT" = true ]; then
              PREVIOUS_TAG="$tag"
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done
          
          # Extract commits
          if [ -n "$PREVIOUS_TAG" ]; then
            # Get commits between previous tag and current tag
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..${CURRENT_TAG} 2>/dev/null || echo "")
          else
            # No previous tag found, get all commits up to current tag
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${CURRENT_TAG} 2>/dev/null || echo "")
          fi
          
          # If no commits found, use a default message
          if [ -z "$COMMITS" ]; then
            COMMITS="- Release ${VERSION}"
          fi
          
          # Read .deb package metadata
          DEB_FILENAME_ARM64=""
          DEB_SHA256_ARM64=""
          DEB_FILENAME_AMD64=""
          DEB_SHA256_AMD64=""
          
          if [ -f "artifacts/deb-packages-arm64/metadata/arm64.txt" ]; then
            source "artifacts/deb-packages-arm64/metadata/arm64.txt"
            DEB_FILENAME_ARM64="${FILENAME}"
            DEB_SHA256_ARM64="${SHA256}"
            echo "deb_filename_arm64=${FILENAME}" >> $GITHUB_OUTPUT
            echo "deb_sha256_arm64=${SHA256}" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "artifacts/deb-packages-amd64/metadata/amd64.txt" ]; then
            source "artifacts/deb-packages-amd64/metadata/amd64.txt"
            DEB_FILENAME_AMD64="${FILENAME}"
            DEB_SHA256_AMD64="${SHA256}"
            echo "deb_filename_amd64=${FILENAME}" >> $GITHUB_OUTPUT
            echo "deb_sha256_amd64=${SHA256}" >> $GITHUB_OUTPUT
          fi
          
          # Get macOS and WASM metadata from job outputs
          DEV_PKG_FILENAME="${{ needs.build-macos.outputs.dev_package_filename }}"
          DEV_PKG_SHA256="${{ needs.build-macos.outputs.dev_package_sha256 }}"
          BOTTLE_FILENAME="${{ needs.build-macos.outputs.bottle_filename }}"
          BOTTLE_SHA256="${{ needs.build-macos.outputs.bottle_sha256 }}"
          WASM_PKG_FILENAME="${{ needs.build-wasm.outputs.wasm_package_filename }}"
          WASM_PKG_SHA256="${{ needs.build-wasm.outputs.wasm_package_sha256 }}"
          
          # Generate release body with resolved values
          {
            echo "## Lotio ${VERSION}"
            echo ""
            echo "### Changes"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "### Packages"
            echo ""
            echo "**Developer package** (binary + headers + libraries for development):"
            echo "- File: \`${DEV_PKG_FILENAME}\`"
            echo "- SHA256: \`${DEV_PKG_SHA256}\`"
            echo ""
            echo "**Homebrew bottle** (pre-built binary for macOS):"
            echo "- File: \`${BOTTLE_FILENAME}\`"
            echo "- SHA256: \`${BOTTLE_SHA256}\`"
            echo ""
            echo "**Debian packages** (Linux):"
            echo "- ARM64: \`${DEB_FILENAME_ARM64}\` (SHA256: \`${DEB_SHA256_ARM64}\`)"
            echo "- AMD64: \`${DEB_FILENAME_AMD64}\` (SHA256: \`${DEB_SHA256_AMD64}\`)"
            echo ""
            echo "**WebAssembly package** (for browser use):"
            echo "- File: \`${WASM_PKG_FILENAME}\`"
            echo "- SHA256: \`${WASM_PKG_SHA256}\`"
            echo ""
            echo "**Docker images** (Linux ARM64 & AMD64, multi-platform):"
            echo "- \`matrunchyk/lotio:${VERSION}\` - Automatically selects correct architecture"
            echo "- \`matrunchyk/lotio-ffmpeg:${VERSION}\` - With FFmpeg, automatically selects correct architecture"
            echo "- Also available as: \`matrunchyk/lotio:latest\` and \`matrunchyk/lotio-ffmpeg:latest\` (multi-platform)"
          } > release_body.md
          
          # Output release body for use in next step
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.deb
            artifacts/**/*.tar.gz
            artifacts/**/*.tgz
          name: Release ${{ needs.version-and-tag.outputs.version }}
          tag_name: ${{ needs.version-and-tag.outputs.version }}
          body: ${{ steps.release_metadata.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

